<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MATHVERSE: Learn Math Through Adventure</title>
  <style>
    /* Modern color scheme */
    :root {
      --primary: #FF6B6B;
      --secondary: #4ECDC4;
      --dark: #292F36;
      --light: #F7FFF7;
      --accent: #FFE66D;
      --error: #FF3D3D;
      --success: #4CAF50;
      --warning: #FFC107;
    }
    
    /* Base styles */
    body {
      font-family: 'Comic Neue', cursive;
      background: var(--dark);
      margin: 0;
      padding: 20px;
      color: var(--light);
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(255,107,107,0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(78,205,196,0.1) 0%, transparent 20%);
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow-x: hidden;
    }
    
    /* LED Border Effects */
    .led-border {
      position: fixed;
      pointer-events: none;
      z-index: 100;
    }
    
    #led-top {
      top: 0;
      left: 0;
      right: 0;
      height: 10px;
      background: linear-gradient(90deg, 
        #FF0000, #FF7F00, #FFFF00, #00FF00, 
        #0000FF, #4B0082, #9400D3, #FF0000);
      background-size: 800% 800%;
      animation: ledScroll 5s linear infinite;
    }
    
    #led-bottom {
      bottom: 0;
      left: 0;
      right: 0;
      height: 10px;
      background: linear-gradient(90deg, 
        #9400D3, #4B0082, #0000FF, #00FF00, 
        #FFFF00, #FF7F00, #FF0000, #9400D3);
      background-size: 800% 800%;
      animation: ledScroll 7s linear infinite reverse;
    }
    
    #led-left {
      top: 0;
      bottom: 0;
      left: 0;
      width: 10px;
      background: linear-gradient(0deg, 
        #FF0000, #FF7F00, #FFFF00, #00FF00, 
        #0000FF, #4B0082, #9400D3, #FF0000);
      background-size: 800% 800%;
      animation: ledScroll 6s linear infinite;
    }
    
    #led-right {
      top: 0;
      bottom: 0;
      right: 0;
      width: 10px;
      background: linear-gradient(0deg, 
        #9400D3, #4B0082, #0000FF, #00FF00, 
        #FFFF00, #FF7F00, #FF0000, #9400D3);
      background-size: 800% 800%;
      animation: ledScroll 8s linear infinite reverse;
    }
    
    @keyframes ledScroll {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    
    /* LED Pulse Effects */
    .led-pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 1;
      opacity: 0;
    }
    
    .led-pulse.red {
      box-shadow: 0 0 100px 50px rgba(255, 0, 0, 0.7);
    }
    
    .led-pulse.green {
      box-shadow: 0 0 100px 50px rgba(0, 255, 0, 0.7);
    }
    
    .led-pulse.blue {
      box-shadow: 0 0 100px 50px rgba(0, 0, 255, 0.7);
    }
    
    .led-pulse.yellow {
      box-shadow: 0 0 100px 50px rgba(255, 255, 0, 0.7);
    }
    
    /* Game container */
    #game-container {
      max-width: 800px;
      width: 100%;
      margin: 20px auto;
      padding: 25px;
      background: rgba(41, 47, 54, 0.9);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      border: 3px solid var(--secondary);
      position: relative;
      overflow: hidden;
      z-index: 2;
    }
    
    /* Header */
    h1 {
      color: var(--accent);
      text-shadow: 3px 3px 0 var(--primary);
      font-size: 2.8rem;
      margin: 0 0 20px;
      font-weight: 700;
      letter-spacing: 1px;
      position: relative;
    }
    
    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, 
        var(--primary), var(--secondary), var(--accent));
      border-radius: 3px;
    }
    
    /* Grade selector */
    #grade-selector {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .grade-btn {
      padding: 10px 20px;
      background: var(--secondary);
      color: var(--dark);
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    
    .grade-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.2);
      background: var(--accent);
    }
    
    .grade-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to bottom right,
        rgba(255,255,255,0) 45%,
        rgba(255,255,255,0.8) 50%,
        rgba(255,255,255,0) 55%
      );
      transform: rotate(30deg);
      opacity: 0;
      transition: all 0.3s;
    }
    
    .grade-btn:hover::after {
      opacity: 1;
      left: 100%;
    }
    
    /* Battle arena */
    #battle-arena {
      position: relative;
      height: 250px;
      margin: 20px 0;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      overflow: hidden;
      border: 2px dashed var(--secondary);
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 30px;
    }
    
    /* Characters */
    .character {
      width: 120px;
      height: 120px;
      position: relative;
      z-index: 2;
      transition: all 0.3s;
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
    }
    
    #hero {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="40" r="30" fill="%234ECDC4"/><rect x="40" y="70" width="20" height="30" fill="%234ECDC4"/><circle cx="40" cy="35" r="5" fill="%23292F36"/><circle cx="60" cy="35" r="5" fill="%23292F36"/></svg>') center/contain no-repeat;
    }
    
    #enemy {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50 20 L90 50 L70 90 L30 90 L10 50 Z" fill="%23FF6B6B"/><circle cx="35" cy="50" r="8" fill="%23292F36"/><circle cx="65" cy="50" r="8" fill="%23292F36"/></svg>') center/contain no-repeat;
    }
    
    /* Teacher character */
    #teacher {
      position: absolute;
      width: 80px;
      height: 80px;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="35" r="25" fill="%23FFE66D"/><path d="M30 60 Q50 80 70 60" stroke="%23292F36" stroke-width="3" fill="none"/><circle cx="40" cy="30" r="3" fill="%23292F36"/><circle cx="60" cy="30" r="3" fill="%23292F36"/></svg>') center/contain no-repeat;
      z-index: 4;
      display: none;
      filter: drop-shadow(0 0 5px rgba(255,230,109,0.5));
    }
    
    .speech-bubble {
      position: absolute;
      background: white;
      color: var(--dark);
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      max-width: 200px;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
      display: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      animation: float 2s ease-in-out infinite;
    }
    
    .speech-bubble:after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      margin-left: -10px;
      border-width: 10px 10px 0;
      border-style: solid;
      border-color: white transparent transparent;
    }
    
    /* Health bars */
    .health-container {
      width: 100%;
      position: absolute;
      top: 10px;
      left: 0;
      padding: 0 30px;
      z-index: 3;
    }
    
    .health-bar {
      height: 20px;
      background: #333;
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
    }
    
    .health-fill {
      height: 100%;
      transition: width 0.5s;
    }
    
    #hero-health { 
      background: linear-gradient(to right, var(--secondary), #2BBBAD);
      width: 100%;
    }
    
    #enemy-health { 
      background: linear-gradient(to right, var(--primary), #FF5252);
      width: 100%;
    }
    
    .health-text {
      position: absolute;
      width: 100%;
      text-align: center;
      font-size: 0.9rem;
      color: white;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
      font-weight: bold;
    }
    
    /* Problem display */
    #problem-display {
      font-size: 1.8rem;
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      min-height: 80px;
      border: 2px solid var(--accent);
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.4;
      box-shadow: inset 0 0 10px rgba(255,230,109,0.2);
      position: relative;
    }
    
    #problem-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, 
        var(--primary), var(--secondary), var(--accent));
      border-radius: 0 0 3px 3px;
    }
    
    /* Answer input */
    #answer-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    #answer-input {
      padding: 15px;
      font-size: 1.3rem;
      width: 250px;
      max-width: 100%;
      text-align: center;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.9);
      font-family: 'Comic Neue', cursive;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    #answer-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(255,230,109,0.5);
      border-color: var(--accent);
    }
    
    #submit-btn {
      padding: 15px 30px;
      font-size: 1.2rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    
    #submit-btn:hover {
      background: #FF5252;
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.2);
    }
    
    #submit-btn:disabled {
      background: #777;
      transform: none;
      box-shadow: none;
      cursor: not-allowed;
    }
    
    #submit-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to bottom right,
        rgba(255,255,255,0) 45%,
        rgba(255,255,255,0.8) 50%,
        rgba(255,255,255,0) 55%
      );
      transform: rotate(30deg);
      opacity: 0;
      transition: all 0.3s;
    }
    
    #submit-btn:not(:disabled):hover::after {
      opacity: 0.5;
      left: 100%;
    }
    
    /* Feedback */
    #feedback {
      min-height: 30px;
      font-size: 1.2rem;
      margin: 15px 0;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .success { 
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
      border-left: 4px solid var(--success);
    }
    
    .error { 
      background: rgba(255, 61, 61, 0.2);
      color: var(--error);
      border-left: 4px solid var(--error);
    }
    
    .warning { 
      background: rgba(255, 193, 7, 0.2);
      color: var(--warning);
      border-left: 4px solid var(--warning);
    }
    
    /* Explanation box */
    #explanation {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      border-left: 4px solid var(--secondary);
      text-align: left;
      display: none;
      animation: fadeIn 0.5s ease-out;
    }
    
    #explanation h3 {
      margin-top: 0;
      color: var(--accent);
    }
    
    /* XP display */
    #xp-display {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .xp-item {
      background: rgba(255,255,255,0.1);
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    #xp-counter {
      color: var(--accent);
      font-weight: bold;
    }
    
    #level-display {
      color: var(--secondary);
      font-weight: bold;
    }
    
    #streak-display {
      color: var(--primary);
      font-weight: bold;
    }
    
    /* Timer */
    #timer {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0,0,0,0.5);
      padding: 8px 15px;
      border-radius: 50px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 5px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    #time {
      font-weight: bold;
      color: var(--accent);
    }
    
    /* Power-up */
    .power-up {
      position: absolute;
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 10;
      animation: float 3s ease-in-out infinite, pulse 1.5s ease-in-out infinite;
      box-shadow: 0 0 20px rgba(255,230,109,0.5);
      display: none;
    }
    
    /* Mobile controls */
    #mobile-controls {
      display: none;
      margin-top: 15px;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .mobile-btn {
      padding: 12px;
      min-width: 40px;
      background: var(--secondary);
      border: none;
      border-radius: 8px;
      color: var(--dark);
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mobile-btn:hover {
      transform: translateY(-2px);
      background: var(--accent);
    }
    
    #btn-clear {
      background: var(--primary);
      color: white;
    }
    
    /* Animations */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }
    
    .shake {
      animation: shake 0.4s ease-in-out;
    }
    
    .attack {
      animation: attack 0.3s ease-out;
    }
    
    @keyframes attack {
      0% { transform: translateX(0); }
      50% { transform: translateX(30px); }
      100% { transform: translateX(0); }
    }
    
    .damage {
      animation: damage 0.3s ease-out;
    }
    
    @keyframes damage {
      0% { transform: translateX(0); }
      50% { transform: translateX(-30px); }
      100% { transform: translateX(0); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Confetti */
    .confetti {
      position: absolute;
      width: 15px;
      height: 15px;
      background-color: var(--accent);
      border-radius: 50%;
      pointer-events: none;
      z-index: 5;
    }
    
    /* Loading screen */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #292F36 0%, #1a1e23 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow: hidden;
    }
    
    .loading-container {
      text-align: center;
      max-width: 600px;
      width: 90%;
      padding: 30px;
      position: relative;
    }
    
    .loading-title {
      font-size: 4rem;
      font-weight: 800;
      margin-bottom: 20px;
      color: transparent;
      background: linear-gradient(90deg, #FF6B6B, #4ECDC4, #FFE66D);
      -webkit-background-clip: text;
      background-clip: text;
      display: flex;
      justify-content: center;
      gap: 5px;
    }
    
    .loading-title span {
      display: inline-block;
      animation: bounce 1.5s infinite alternate;
    }
    
    .loading-title span:nth-child(1) { animation-delay: 0.1s; }
    .loading-title span:nth-child(2) { animation-delay: 0.2s; }
    .loading-title span:nth-child(3) { animation-delay: 0.3s; }
    .loading-title span:nth-child(4) { animation-delay: 0.4s; }
    .loading-title span:nth-child(5) { animation-delay: 0.5s; }
    .loading-title span:nth-child(6) { animation-delay: 0.6s; }
    .loading-title span:nth-child(7) { animation-delay: 0.7s; }
    .loading-title span:nth-child(8) { animation-delay: 0.8s; }
    .loading-title span:nth-child(9) { animation-delay: 0.9s; }
    
    .loading-subtitle {
      font-size: 1.5rem;
      color: #F7FFF7;
      margin-bottom: 30px;
      opacity: 0.8;
      animation: pulse 2s infinite;
    }
    
    .loading-progress {
      height: 10px;
      background: rgba(247, 255, 247, 0.1);
      border-radius: 5px;
      margin: 0 auto 40px;
      overflow: hidden;
      max-width: 400px;
    }
    
    .progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #FF6B6B, #4ECDC4);
      border-radius: 5px;
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.6) 50%,
        rgba(255, 255, 255, 0) 100%
      );
      animation: shimmer 2s infinite;
    }
    
    .loading-math-symbols {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .loading-math-symbols .symbol {
      font-size: 2rem;
      color: #FFE66D;
      animation: float 3s infinite ease-in-out;
      text-shadow: 0 0 10px rgba(255, 230, 109, 0.5);
    }
    
    .loading-tip {
      font-size: 1.1rem;
      color: rgba(247, 255, 247, 0.7);
      font-style: italic;
      max-width: 500px;
      margin: 0 auto;
      min-height: 40px;
    }
    
    @keyframes bounce {
      0% { transform: translateY(0); }
      100% { transform: translateY(-15px); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      #game-container {
        padding: 15px;
        border-radius: 15px;
      }
      
      h1 {
        font-size: 2.2rem;
      }
      
      #battle-arena {
        height: 200px;
        padding: 0 15px;
      }
      
      .character {
        width: 90px;
        height: 90px;
      }
      
      #problem-display {
        font-size: 1.5rem;
        padding: 15px;
      }
      
      #answer-container {
        flex-direction: column;
        align-items: center;
      }
      
      #answer-input {
        width: 100%;
      }
      
      #submit-btn {
        width: 100%;
      }
      
      #mobile-controls {
        display: flex;
      }
      
      .loading-title {
        font-size: 3rem;
      }
      
      .loading-subtitle {
        font-size: 1.2rem;
      }
      
      .loading-math-symbols .symbol {
        font-size: 1.5rem;
      }
    }
    
    @media (max-width: 480px) {
      .grade-btn {
        padding: 8px 15px;
        font-size: 1rem;
      }
      
      #problem-display {
        font-size: 1.3rem;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- LED Border Effects -->
  <div id="led-top" class="led-border"></div>
  <div id="led-bottom" class="led-border"></div>
  <div id="led-left" class="led-border"></div>
  <div id="led-right" class="led-border"></div>
  
  <!-- LED Pulse Effects -->
  <div id="led-pulse" class="led-pulse"></div>
  
  <!-- Loading Screen -->
  <div id="loading-screen">
    <div class="loading-container">
      <div class="loading-title">
        <span>M</span>
        <span>A</span>
        <span>T</span>
        <span>H</span>
        <span>V</span>
        <span>E</span>
        <span>R</span>
        <span>S</span>
        <span>E</span>
      </div>
      <div class="loading-subtitle">Preparing Your Math Adventure</div>
      <div class="loading-progress">
        <div class="progress-bar"></div>
      </div>
      <div class="loading-math-symbols">
        <div class="symbol">+</div>
        <div class="symbol">−</div>
        <div class="symbol">×</div>
        <div class="symbol">÷</div>
        <div class="symbol">=</div>
        <div class="symbol">√</div>
        <div class="symbol">π</div>
        <div class="symbol">∞</div>
      </div>
      <div class="loading-tip" id="loading-tip"></div>
    </div>
  </div>

  <!-- Main Game Container -->
  <div id="game-container">
    <div id="timer">⏱️ <span id="time">60</span>s</div>
    <h1>MATHVERSE ADVENTURE</h1>
    
    <div id="grade-selector">
      <h2>Choose Your Grade Level:</h2>
    </div>
    
    <div id="battle-arena">
      <div class="health-container">
        <div class="health-bar">
          <div id="hero-health" class="health-fill"></div>
          <div class="health-text" id="hero-health-text">100/100</div>
        </div>
        <div class="health-bar">
          <div id="enemy-health" class="health-fill"></div>
          <div class="health-text" id="enemy-health-text">100/100</div>
        </div>
      </div>
      
      <div id="hero" class="character"></div>
      <div id="teacher"></div>
      <div id="enemy" class="character"></div>
      
      <div class="speech-bubble" id="teacher-speech"></div>
      <div id="power-up" class="power-up">✨</div>
    </div>
    
    <div id="problem-display">
      Select your grade to begin your math adventure!
    </div>
    
    <div id="feedback"></div>
    <div id="explanation"></div>
    
    <div id="answer-container">
      <input type="text" id="answer-input" placeholder="Type your answer..." disabled>
      <button id="submit-btn" disabled>SUBMIT</button>
    </div>
    
    <div id="mobile-controls">
      <button class="mobile-btn" id="btn-7">7</button>
      <button class="mobile-btn" id="btn-8">8</button>
      <button class="mobile-btn" id="btn-9">9</button>
      <button class="mobile-btn" id="btn-4">4</button>
      <button class="mobile-btn" id="btn-5">5</button>
      <button class="mobile-btn" id="btn-6">6</button>
      <button class="mobile-btn" id="btn-1">1</button>
      <button class="mobile-btn" id="btn-2">2</button>
      <button class="mobile-btn" id="btn-3">3</button>
      <button class="mobile-btn" id="btn-0">0</button>
      <button class="mobile-btn" id="btn-clear">⌫</button>
    </div>
    
    <div id="xp-display">
      <div class="xp-item">⭐ XP: <span id="xp-counter">0</span></div>
      <div class="xp-item">🏆 Level: <span id="level-display">1</span></div>
      <div class="xp-item">🔥 Streak: <span id="streak-display">0</span></div>
    </div>
  </div>

  <!-- Audio elements -->
  <audio id="correct-sound" src="https://assets.codepen.io/605876/correct.mp3" preload="auto"></audio>
  <audio id="wrong-sound" src="https://assets.codepen.io/605876/wrong.mp3" preload="auto"></audio>
  <audio id="levelup-sound" src="https://assets.codepen.io/605876/levelup.mp3" preload="auto"></audio>
  <audio id="powerup-sound" src="https://assets.codepen.io/605876/powerup.mp3" preload="auto"></audio>
  <audio id="teacher-sound" src="https://assets.codepen.io/605876/positive.mp3" preload="auto"></audio>

  <script>
    // ==============================================
    // COMPLETE MATH PROBLEM GENERATOR (GRADES 1-12)
    // ==============================================
    class MathProblemGenerator {
      constructor(grade) {
        this.grade = Math.max(1, Math.min(12, parseInt(grade) || 1));
        this.difficulty = 0.5 + (this.grade * 0.1);
        this.recentGenerators = [];
        this.maxRecent = 5;
      }

      generate() {
        try {
          const generators = this.getAvailableGenerators();
          if (generators.length === 0) return this.getFallbackProblem();
          
          const generator = this.selectGenerator(generators);
          const problem = generator.call(this);
          
          if (this.validateProblem(problem)) {
            this.recentGenerators.push(generator.name);
            if (this.recentGenerators.length > this.maxRecent) {
              this.recentGenerators.shift();
            }
            return problem;
          }
          return this.getFallbackProblem();
        } catch (e) {
          console.error("Problem generation error:", e);
          return this.getFallbackProblem();
        }
      }

      getAvailableGenerators() {
        const allGenerators = [
          this.generateAddition,
          this.generateSubtraction,
          this.generateMultiplication,
          this.generateDivision,
          this.generateFractions,
          this.generateDecimals,
          this.generateAlgebra,
          this.generateGeometry,
          this.generateWordProblem,
          this.generateExponents,
          this.generateSquareRoots,
          this.generatePercentages,
          this.generateOrderOfOperations,
          this.generateInequalities,
          this.generateAbsoluteValue,
          this.generateFactors,
          this.generateMultiples,
          this.generatePrimeNumbers,
          this.generateSequences,
          this.generateProbability
        ];
        
        return allGenerators.filter(gen => {
          try {
            const problem = gen.call(this);
            return problem && this.validateProblem(problem);
          } catch {
            return false;
          }
        });
      }

      selectGenerator(generators) {
        // Weight generators that haven't been used recently
        const weights = generators.map(gen => {
          const lastUsed = this.recentGenerators.lastIndexOf(gen.name);
          return lastUsed === -1 ? 5 : Math.max(1, 5 - (this.recentGenerators.length - lastUsed));
        });
        
        const totalWeight = weights.reduce((sum, w) => sum + w, 0);
        let random = Math.random() * totalWeight;
        
        for (let i = 0; i < generators.length; i++) {
          if (random < weights[i]) return generators[i];
          random -= weights[i];
        }
        
        return generators[0];
      }

      // ========== GRADE-SPECIFIC GENERATORS ==========
      
      // Basic Arithmetic (Grades 1-3)
      generateAddition() {
        const max = Math.floor(5 + (this.grade * 5));
        const a = this.randomInt(1, max);
        const b = this.randomInt(1, max);
        return {
          question: `${a} + ${b} = ?`,
          answer: (a + b).toString(),
          type: "addition",
          explanation: `To add ${a} and ${b}, count ${a} items and then count ${b} more items. The total is ${a + b}.`
        };
      }

      generateSubtraction() {
        const max = Math.floor(5 + (this.grade * 5));
        const a = this.randomInt(1, max);
        const b = this.randomInt(1, a); // Ensure positive result
        return {
          question: `${a} - ${b} = ?`,
          answer: (a - b).toString(),
          type: "subtraction",
          explanation: `To subtract ${b} from ${a}, start with ${a} items and remove ${b} items. You're left with ${a - b} items.`
        };
      }

      generateMultiplication() {
        const max = Math.min(12, 2 + this.grade);
        const a = this.randomInt(1, max);
        const b = this.randomInt(1, max);
        return {
          question: `${a} × ${b} = ?`,
          answer: (a * b).toString(),
          type: "multiplication",
          explanation: `Multiplication is repeated addition. ${a} × ${b} means ${a} added to itself ${b} times: ${Array(b).fill(a).join(' + ')} = ${a * b}.`
        };
      }

      generateDivision() {
        const max = Math.min(12, 2 + this.grade);
        const b = this.randomInt(1, max);
        const product = b * this.randomInt(1, max);
        return {
          question: `${product} ÷ ${b} = ?`,
          answer: (product / b).toString(),
          type: "division",
          explanation: `Division is splitting into equal parts. ${product} ÷ ${b} means splitting ${product} into ${b} equal groups. Each group has ${product / b} items.`
        };
      }

      // Fractions (Grades 3-6)
      generateFractions() {
        if (this.grade < 3) return null;
        
        const denominators = [2, 3, 4, 5, 6, 8, 10];
        const d = denominators[this.randomInt(0, Math.min(this.grade-2, denominators.length-1))];
        const n1 = this.randomInt(1, d-1);
        const n2 = this.randomInt(1, d-1);
        
        if (this.grade >= 5) {
          // Fraction addition/subtraction
          const op = this.randomChoice(['+', '-']);
          let question, answer, explanation;
          
          if (op === '+') {
            const sumNum = n1 + n2;
            if (sumNum <= d) {
              question = `${n1}/${d} + ${n2}/${d} = ?`;
              answer = `${sumNum}/${d}`;
              explanation = `When adding fractions with the same denominator (${d}), just add the numerators: ${n1} + ${n2} = ${sumNum}. The denominator stays ${d}.`;
            } else {
              question = `${n1}/${d} + ${n2}/${d} = ?`;
              answer = `1 ${sumNum-d}/${d}`;
              explanation = `${n1}/${d} + ${n2}/${d} = ${sumNum}/${d}. Since ${sumNum} is larger than ${d}, we can simplify to 1 ${sumNum-d}/${d}.`;
            }
          } else {
            question = `${Math.max(n1,n2)}/${d} - ${Math.min(n1,n2)}/${d} = ?`;
            answer = `${Math.abs(n1-n2)}/${d}`;
            explanation = `When subtracting fractions with the same denominator (${d}), subtract the numerators: ${Math.max(n1,n2)} - ${Math.min(n1,n2)} = ${Math.abs(n1-n2)}. The denominator stays ${d}.`;
          }
          
          return {
            question: question,
            answer: answer,
            type: "fractions",
            explanation: explanation
          };
        } else {
          // Simple fraction recognition
          return {
            question: `Shade ${n1}/${d} of the circle. How many parts are shaded?`,
            answer: n1.toString(),
            type: "fractions",
            explanation: `The fraction ${n1}/${d} means ${n1} out of ${d} equal parts are shaded.`
          };
        }
      }

      // Decimals (Grades 4-6)
      generateDecimals() {
        if (this.grade < 4) return null;
        
        const decimalPlaces = this.randomInt(1, Math.min(3, this.grade - 2));
        const factor = Math.pow(10, decimalPlaces);
        const a = this.randomInt(1, 9 * factor) / factor;
        const b = this.randomInt(1, 9 * factor) / factor;
        
        const operations = ['+', '-'];
        if (this.grade >= 5) operations.push('×');
        if (this.grade >= 6) operations.push('÷');
        
        const op = this.randomChoice(operations);
        let question, answer, explanation;
        
        switch(op) {
          case '+':
            question = `${a} + ${b} = ?`;
            answer = (a + b).toFixed(decimalPlaces);
            explanation = `Line up the decimal points and add: ${a} + ${b} = ${(a + b).toFixed(decimalPlaces)}`;
            break;
          case '-':
            question = `${Math.max(a,b)} - ${Math.min(a,b)} = ?`;
            answer = (Math.max(a,b) - Math.min(a,b)).toFixed(decimalPlaces);
            explanation = `Line up the decimal points and subtract: ${Math.max(a,b)} - ${Math.min(a,b)} = ${(Math.max(a,b) - Math.min(a,b)).toFixed(decimalPlaces)}`;
            break;
          case '×':
            question = `${a} × ${b} = ?`;
            answer = (a * b).toFixed(decimalPlaces * 2);
            explanation = `Multiply normally, then count the decimal places: ${a} (${decimalPlaces} decimal places) × ${b} (${decimalPlaces} decimal places) = ${(a * b).toFixed(decimalPlaces * 2)} (${decimalPlaces * 2} decimal places)`;
            break;
          case '÷':
            question = `${a} ÷ ${b} = ? (rounded to ${decimalPlaces} decimal places)`;
            answer = (a / b).toFixed(decimalPlaces);
            explanation = `Divide normally and round to ${decimalPlaces} decimal places: ${a} ÷ ${b} ≈ ${(a / b).toFixed(decimalPlaces)}`;
            break;
        }
        
        return {
          question: question,
          answer: answer,
          type: "decimals",
          explanation: explanation
        };
      }

      // Algebra (Grades 6-12)
      generateAlgebra() {
        if (this.grade < 6) return null;
        
        const types = [];
        
        // Linear equations
        types.push(() => {
          const a = this.randomInt(1, Math.max(2, this.grade - 2));
          const b = this.randomInt(1, Math.max(3, this.grade * 2));
          const x = this.randomInt(1, Math.max(2, this.grade - 1));
          return {
            question: `${a}x + ${b} = ${a*x + b}. Solve for x`,
            answer: x.toString(),
            type: "algebra",
            explanation: `Subtract ${b} from both sides: ${a}x = ${a*x}. Then divide both sides by ${a}: x = ${x}.`
          };
        });
        
        // Quadratic equations (grades 9+)
        if (this.grade >= 9) {
          types.push(() => {
            const root = this.randomInt(1, Math.max(2, this.grade - 6));
            return {
              question: `x² - ${2*root}x + ${root*root} = 0. Find x`,
              answer: root.toString(),
              type: "algebra",
              explanation: `This factors to (x - ${root})² = 0, so the solution is x = ${root}.`
            };
          });
        }
        
        // Systems of equations (grades 8+)
        if (this.grade >= 8) {
          types.push(() => {
            const x = this.randomInt(1, 5);
            const y = this.randomInt(1, 5);
            const a = this.randomInt(1, 3);
            const b = this.randomInt(1, 3);
            const c = a*x + b*y;
            const d = this.randomInt(1, 3);
            const e = this.randomInt(1, 3);
            const f = d*x + e*y;
            
            return {
              question: `Solve the system:\n${a}x + ${b}y = ${c}\n${d}x + ${e}y = ${f}`,
              answer: `x=${x}, y=${y}`,
              type: "algebra",
              explanation: `You can solve by substitution or elimination. The solution is x = ${x}, y = ${y}.`
            };
          });
        }
        
        return types[Math.floor(Math.random() * types.length)]();
      }

      // Geometry (Grades 4-12)
      generateGeometry() {
        if (this.grade < 4) return null;
        
        const types = [];
        
        // Area and perimeter (grades 4-6)
        if (this.grade >= 4 && this.grade <= 6) {
          types.push(() => {
            const length = this.randomInt(2, 10);
            const width = this.randomInt(2, 10);
            
            if (Math.random() > 0.5) {
              return {
                question: `A rectangle has length ${length} and width ${width}. What is its area?`,
                answer: (length * width).toString(),
                type: "geometry",
                explanation: `Area of a rectangle = length × width = ${length} × ${width} = ${length * width}.`
              };
            } else {
              return {
                question: `A rectangle has length ${length} and width ${width}. What is its perimeter?`,
                answer: (2 * (length + width)).toString(),
                type: "geometry",
                explanation: `Perimeter of a rectangle = 2 × (length + width) = 2 × (${length} + ${width}) = ${2 * (length + width)}.`
              };
            }
          });
        }
        
        // Circle problems (grades 7+)
        if (this.grade >= 7) {
          types.push(() => {
            const radius = this.randomInt(1, 10);
            
            if (Math.random() > 0.5) {
              return {
                question: `A circle has radius ${radius}. What is its area? (Use π = 3.14)`,
                answer: (3.14 * radius * radius).toFixed(2),
                type: "geometry",
                explanation: `Area of a circle = π × radius² = 3.14 × ${radius}² = ${(3.14 * radius * radius).toFixed(2)}.`
              };
            } else {
              return {
                question: `A circle has radius ${radius}. What is its circumference? (Use π = 3.14)`,
                answer: (2 * 3.14 * radius).toFixed(2),
                type: "geometry",
                explanation: `Circumference of a circle = 2 × π × radius = 2 × 3.14 × ${radius} = ${(2 * 3.14 * radius).toFixed(2)}.`
              };
            }
          });
        }
        
        // Pythagorean theorem (grades 8+)
        if (this.grade >= 8) {
          types.push(() => {
            const a = this.randomInt(3, 8);
            const b = this.randomInt(3, 8);
            const c = Math.sqrt(a*a + b*b).toFixed(2);
            
            if (Math.random() > 0.5) {
              return {
                question: `A right triangle has legs ${a} and ${b}. What is the length of the hypotenuse?`,
                answer: c,
                type: "geometry",
                explanation: `Using the Pythagorean theorem: hypotenuse = √(${a}² + ${b}²) = √(${a*a} + ${b*b}) ≈ ${c}.`
              };
            } else {
              return {
                question: `A right triangle has one leg ${a} and hypotenuse ${c}. What is the length of the other leg?`,
                answer: b.toString(),
                type: "geometry",
                explanation: `Using the Pythagorean theorem: other leg = √(${c}² - ${a}²) = √(${(a*a + b*b).toFixed(2)} - ${a*a}) ≈ ${b}.`
              };
            }
          });
        }
        
        // Volume problems (grades 9+)
        if (this.grade >= 9) {
          types.push(() => {
            const length = this.randomInt(2, 10);
            const width = this.randomInt(2, 10);
            const height = this.randomInt(2, 10);
            
            return {
              question: `A rectangular prism has length ${length}, width ${width}, and height ${height}. What is its volume?`,
              answer: (length * width * height).toString(),
              type: "geometry",
              explanation: `Volume of a rectangular prism = length × width × height = ${length} × ${width} × ${height} = ${length * width * height}.`
            };
          });
        }
        
        return types[Math.floor(Math.random() * types.length)]();
      }

      // Word Problems (All grades)
      generateWordProblem() {
        const types = [];
        
        // Basic word problems (grades 1-3)
        if (this.grade <= 3) {
          types.push(() => {
            const a = this.randomInt(1, 10);
            const b = this.randomInt(1, 10);
            
            if (Math.random() > 0.5) {
              return {
                question: `If you have ${a} apples and get ${b} more, how many apples do you have?`,
                answer: (a + b).toString(),
                type: "word problem",
                explanation: `You started with ${a} apples and added ${b} more, so you have ${a} + ${b} = ${a + b} apples.`
              };
            } else {
              return {
                question: `If you have ${a} apples and give away ${Math.min(a, b)} apples, how many apples do you have left?`,
                answer: (a - Math.min(a, b)).toString(),
                type: "word problem",
                explanation: `You started with ${a} apples and gave away ${Math.min(a, b)}, so you have ${a} - ${Math.min(a, b)} = ${a - Math.min(a, b)} apples left.`
              };
            }
          });
        }
        
        // More complex word problems (grades 4-6)
        if (this.grade >= 4 && this.grade <= 6) {
          types.push(() => {
            const a = this.randomInt(5, 20);
            const b = this.randomInt(5, 20);
            const c = this.randomInt(2, 5);
            
            if (Math.random() > 0.5) {
              return {
                question: `A pizza is cut into ${a} slices. If ${b} slices are eaten, what fraction of the pizza is left?`,
                answer: `${a - b}/${a}`,
                type: "word problem",
                explanation: `There were ${a} slices total, and ${b} were eaten, leaving ${a - b} slices. So ${a - b}/${a} of the pizza remains.`
              };
            } else {
              return {
                question: `If ${c} friends share ${a} cookies equally, how many cookies does each friend get?`,
                answer: Math.floor(a / c).toString(),
                type: "word problem",
                explanation: `Divide ${a} cookies among ${c} friends: ${a} ÷ ${c} = ${Math.floor(a / c)} cookies each.`
              };
            }
          });
        }
        
        // Advanced word problems (grades 7+)
        if (this.grade >= 7) {
          types.push(() => {
            const a = this.randomInt(10, 50);
            const b = this.randomInt(5, 20);
            const c = this.randomInt(2, 10);
            
            if (Math.random() > 0.5) {
              return {
                question: `A train travels ${a} miles in ${b} minutes. What is its speed in miles per hour?`,
                answer: Math.round((a / b) * 60).toString(),
                type: "word problem",
                explanation: `First find miles per minute: ${a} miles / ${b} minutes = ${(a/b).toFixed(2)} miles/minute. Then multiply by 60 to get miles/hour: ${(a/b).toFixed(2)} × 60 ≈ ${Math.round((a / b) * 60)} mph.`
              };
            } else {
              return {
                question: `A ${c}% discount on a $${a} item saves how much money?`,
                answer: `$${(a * c / 100).toFixed(2)}`,
                type: "word problem",
                explanation: `${c}% of $${a} = 0.${c} × ${a} = $${(a * c / 100).toFixed(2)}.`
              };
            }
          });
        }
        
        return types[Math.floor(Math.random() * types.length)]();
      }

      // Exponents and Roots (Grades 6-12)
      generateExponents() {
        if (this.grade < 6) return null;
        
        const bases = [2, 3, 4, 5, 10];
        const base = bases[this.randomInt(0, bases.length-1)];
        
        if (this.grade >= 10) {
          // Advanced exponent rules
          const rule = this.randomChoice([
            'power', 'product', 'quotient', 'negative'
          ]);
          
          let question, answer, explanation;
          const exp1 = this.randomInt(2, 5);
          const exp2 = this.randomInt(2, 5);
          
          switch(rule) {
            case 'power':
              question = `Simplify: (${base}^${exp1})^${exp2}`;
              answer = `${base}^${exp1*exp2}`;
              explanation = `When raising a power to another power, multiply the exponents: (${base}^${exp1})^${exp2} = ${base}^(${exp1}×${exp2}) = ${base}^${exp1*exp2}.`;
              break;
            case 'product':
              question = `Simplify: ${base}^${exp1} × ${base}^${exp2}`;
              answer = `${base}^${exp1+exp2}`;
              explanation = `When multiplying with the same base, add the exponents: ${base}^${exp1} × ${base}^${exp2} = ${base}^(${exp1}+${exp2}) = ${base}^${exp1+exp2}.`;
              break;
            case 'quotient':
              question = `Simplify: ${base}^${exp1} ÷ ${base}^${exp2}`;
              answer = `${base}^${exp1-exp2}`;
              explanation = `When dividing with the same base, subtract the exponents: ${base}^${exp1} ÷ ${base}^${exp2} = ${base}^(${exp1}-${exp2}) = ${base}^${exp1-exp2}.`;
              break;
            case 'negative':
              question = `Evaluate: ${base}^-${exp1}`;
              answer = `1/${Math.pow(base, exp1)}`;
              explanation = `A negative exponent means the reciprocal: ${base}^-${exp1} = 1/${base}^${exp1} = 1/${Math.pow(base, exp1)}.`;
              break;
          }
          
          return {
            question: question,
            answer: answer,
            type: "exponents",
            explanation: explanation
          };
        } else {
          // Basic exponents
          const exp = this.randomInt(2, 5);
          return {
            question: `Evaluate: ${base}^${exp}`,
            answer: Math.pow(base, exp).toString(),
            type: "exponents",
            explanation: `${base}^${exp} means ${base} multiplied by itself ${exp} times: ${Array(exp).fill(base).join(' × ')} = ${Math.pow(base, exp)}.`
          };
        }
      }

      generateSquareRoots() {
        if (this.grade < 7) return null;
        
        const perfectSquares = [4, 9, 16, 25, 36, 49, 64, 81, 100];
        const nonPerfectSquares = [2, 3, 5, 6, 7, 8, 10, 11, 12];
        
        if (Math.random() > 0.5 || this.grade < 9) {
          // Perfect squares
          const square = this.randomChoice(perfectSquares);
          return {
            question: `√${square} = ?`,
            answer: Math.sqrt(square).toString(),
            type: "square roots",
            explanation: `The square root of ${square} is ${Math.sqrt(square)} because ${Math.sqrt(square)} × ${Math.sqrt(square)} = ${square}.`
          };
        } else {
          // Non-perfect squares (round to 2 decimal places)
          const num = this.randomChoice(nonPerfectSquares);
          const root = Math.sqrt(num).toFixed(2);
          return {
            question: `√${num} ≈ ? (round to 2 decimal places)`,
            answer: root,
            type: "square roots",
            explanation: `√${num} is approximately ${root} because ${root} × ${root} ≈ ${num}.`
          };
        }
      }

      // Percentages (Grades 5-12)
      generatePercentages() {
        if (this.grade < 5) return null;
        
        const types = [];
        
        // Basic percentage of a number (grades 5-7)
        types.push(() => {
          const percent = this.randomInt(5, 100);
          const number = this.randomInt(10, 200);
          const answer = (number * percent / 100).toFixed(percent % 10 === 0 ? 0 : 2);
          
          return {
            question: `What is ${percent}% of ${number}?`,
            answer: answer,
            type: "percentages",
            explanation: `To find ${percent}% of ${number}, multiply: ${number} × 0.${percent} = ${answer}.`
          };
        });
        
        // Percentage increase/decrease (grades 7+)
        if (this.grade >= 7) {
          types.push(() => {
            const original = this.randomInt(50, 200);
            const change = this.randomInt(10, 50);
            const isIncrease = Math.random() > 0.5;
            
            if (isIncrease) {
              const newAmount = original + change;
              const percent = ((change / original) * 100).toFixed(1);
              return {
                question: `A price increases from $${original} to $${newAmount}. What is the percentage increase?`,
                answer: `${percent}%`,
                type: "percentages",
                explanation: `First find the increase: $${newAmount} - $${original} = $${change}. Then divide by original: $${change} / $${original} ≈ ${(change/original).toFixed(3)}. Multiply by 100: ${(change/original).toFixed(3)} × 100 ≈ ${percent}%.`
              };
            } else {
              const newAmount = original - change;
              const percent = ((change / original) * 100).toFixed(1);
              return {
                question: `A price decreases from $${original} to $${newAmount}. What is the percentage decrease?`,
                answer: `${percent}%`,
                type: "percentages",
                explanation: `First find the decrease: $${original} - $${newAmount} = $${change}. Then divide by original: $${change} / $${original} ≈ ${(change/original).toFixed(3)}. Multiply by 100: ${(change/original).toFixed(3)} × 100 ≈ ${percent}%.`
              };
            }
          });
        }
        
        // Finding original amount (grades 9+)
        if (this.grade >= 9) {
          types.push(() => {
            const percent = this.randomInt(5, 30);
            const increase = Math.random() > 0.5;
            const original = this.randomInt(100, 500);
            const change = original * percent / 100;
            const newAmount = increase ? original + change : original - change;
            
            return {
              question: `After a ${percent}% ${increase ? 'increase' : 'decrease'}, the new amount is ${newAmount}. What was the original amount?`,
              answer: original.toString(),
              type: "percentages",
              explanation: `Let the original amount be x. Then x ${increase ? '+' : '-'} ${percent}% of x = ${newAmount}. So x × ${increase ? '1.' : '0.'}${percent} = ${newAmount}. Therefore, x = ${newAmount} / ${increase ? '1.' : '0.'}${percent} = ${original}.`
            };
          });
        }
        
        return types[Math.floor(Math.random() * types.length)]();
      }

      // Order of Operations (Grades 5-12)
      generateOrderOfOperations() {
        if (this.grade < 5) return null;
        
        const complexity = Math.min(3 + Math.floor(this.grade / 3), 6);
        let expression = '';
        let answer = 0;
        let explanation = 'Remember PEMDAS (Parentheses, Exponents, Multiplication/Division, Addition/Subtraction): ';
        
        // Build expression based on grade level
        const numCount = 2 + Math.floor(this.grade / 4);
        let numbers = [];
        let operations = [];
        
        // Generate random numbers
        for (let i = 0; i < numCount; i++) {
          numbers.push(this.randomInt(1, 5 + this.grade));
        }
        
        // Generate operations based on grade level
        const possibleOps = ['+', '-', '×'];
        if (this.grade >= 6) possibleOps.push('÷');
        if (this.grade >= 7) possibleOps.push('^');
        
        for (let i = 0; i < numCount - 1; i++) {
          operations.push(this.randomChoice(possibleOps));
        }
        
        // Add parentheses sometimes
        let hasParentheses = this.grade >= 5 && Math.random() > 0.5;
        
        // Build expression and calculate answer
        if (hasParentheses) {
          // Simple two-number parentheses for lower grades
          if (this.grade < 7) {
            expression = `(${numbers[0]} ${operations[0]} ${numbers[1]})`;
            answer = this.calculate(numbers[0], numbers[1], operations[0]);
            explanation += `First calculate inside parentheses: ${numbers[0]} ${operations[0]} ${numbers[1]} = ${answer}.`;
            
            // Add remaining operations
            for (let i = 2; i < numbers.length; i++) {
              expression += ` ${operations[i-1]} ${numbers[i]}`;
              answer = this.calculate(answer, numbers[i], operations[i-1]);
              explanation += ` Then ${answer} ${operations[i-1]} ${numbers[i]} = ${this.calculate(answer, numbers[i], operations[i-1])}.`;
            }
          } else {
            // More complex parentheses for higher grades
            const parenPos = this.randomInt(0, operations.length - 2);
            expression = '';
            
            for (let i = 0; i < operations.length; i++) {
              if (i === parenPos) {
                expression += `(${numbers[i]} ${operations[i]} ${numbers[i+1]})`;
                const parenResult = this.calculate(numbers[i], numbers[i+1], operations[i]);
                explanation += `First calculate inside parentheses: ${numbers[i]} ${operations[i]} ${numbers[i+1]} = ${parenResult}. `;
                
                // Build remaining expression
                if (i < operations.length - 2) {
                  expression += ` ${operations[i+1]} `;
                }
                i++; // Skip next number since we used it in parentheses
              } else {
                expression += `${numbers[i]} ${operations[i]} `;
              }
            }
            
            // Calculate final answer
            answer = eval(expression.replace(/×/g, '*').replace(/÷/g, '/').replace(/\^/g, '**'));
            explanation += `Then evaluate the remaining expression: ${expression} = ${answer}.`;
          }
        } else {
          // No parentheses
          expression = `${numbers[0]}`;
          answer = numbers[0];
          
          for (let i = 0; i < operations.length; i++) {
            expression += ` ${operations[i]} ${numbers[i+1]}`;
          }
          
          // Calculate with proper order of operations
          answer = eval(expression.replace(/×/g, '*').replace(/÷/g, '/').replace(/\^/g, '**'));
          explanation += `Evaluate multiplication/division before addition/subtraction: ${expression} = ${answer}.`;
        }
        
        return {
          question: `Evaluate: ${expression}`,
          answer: answer.toString(),
          type: "order of operations",
          explanation: explanation
        };
      }

      // Inequalities (Grades 6-12)
      generateInequalities() {
        if (this.grade < 6) return null;
        
        const types = [];
        
        // Simple inequalities (grades 6-8)
        types.push(() => {
          const a = this.randomInt(1, 10);
          const b = this.randomInt(1, 10);
          const op = this.randomChoice(['<', '>', '≤', '≥']);
          
          let question, answer, explanation;
          
          if (Math.random() > 0.5) {
            // Compare numbers directly
            question = `Which is correct? ${a} __ ${b}`;
            answer = this.compareNumbers(a, b, op);
            explanation = `${a} ${answer} ${b} because ${this.getComparisonExplanation(a, b)}`;
          } else {
            // Solve simple inequality
            const x = this.randomInt(1, 10);
            const c = this.randomInt(1, 10);
            let expression, solution;
            
            if (Math.random() > 0.5) {
              expression = `${x}x + ${c} ${op} ${x * this.randomInt(2, 5) + c}`;
              solution = `x ${op} ${this.randomInt(2, 5)}`;
            } else {
              expression = `${x}x - ${c} ${op} ${x * this.randomInt(2, 5) - c}`;
              solution = `x ${op} ${this.randomInt(2, 5)}`;
            }
            
            question = `Solve for x: ${expression}`;
            answer = solution;
            explanation = `First subtract ${c} from both sides, then divide both sides by ${x}: ${expression} → ${solution}.`;
          }
          
          return {
            question: question,
            answer: answer,
            type: "inequalities",
            explanation: explanation
          };
        });
        
        // Compound inequalities (grades 9+)
        if (this.grade >= 9) {
          types.push(() => {
            const a = this.randomInt(1, 5);
            const b = this.randomInt(6, 10);
            const c = this.randomInt(1, 5);
            const d = this.randomInt(6, 10);
            
            return {
              question: `Solve the compound inequality: ${a} < x < ${b} AND ${c} < x < ${d}`,
              answer: `${Math.max(a, c)} < x < ${Math.min(b, d)}`,
              type: "inequalities",
              explanation: `The solution must satisfy both inequalities. The overlapping range is from ${Math.max(a, c)} to ${Math.min(b, d)}.`
            };
          });
        }
        
        return types[Math.floor(Math.random() * types.length)]();
      }

      // Absolute Value (Grades 7-12)
      generateAbsoluteValue() {
        if (this.grade < 7) return null;
        
        const types = [];
        
        // Simple absolute value evaluation
        types.push(() => {
          const num = this.randomInt(-20, 20);
          return {
            question: `What is |${num}|?`,
            answer: Math.abs(num).toString(),
            type: "absolute value",
            explanation: `The absolute value of a number is its distance from 0 on the number line. |${num}| = ${Math.abs(num)}.`
          };
        });
        
        // Absolute value equations (grades 8+)
        if (this.grade >= 8) {
          types.push(() => {
            const solution = this.randomInt(-5, 5);
            const equation = `|x ${solution >= 0 ? '-' : '+'} ${Math.abs(solution)}| = ${this.randomInt(1, 5)}`;
            const answers = [];
            
            if (Math.random() > 0.5) {
              // Single solution case
              const value = this.randomInt(1, 10);
              return {
                question: `Solve: |x| = ${value}`,
                answer: `x = ${value} or x = -${value}`,
                type: "absolute value",
                explanation: `If |x| = ${value}, then x could be ${value} or -${value} because both are ${value} units from 0.`
              };
            } else {
              // Two solution case
              const a = this.randomInt(1, 5);
              const b = this.randomInt(1, 5);
              return {
                question: `Solve: |x - ${a}| = ${b}`,
                answer: `x = ${a + b} or x = ${a - b}`,
                type: "absolute value",
                explanation: `If |x - ${a}| = ${b}, then (x - ${a}) could be ${b} or -${b}. So x = ${a} + ${b} = ${a + b} OR x = ${a} - ${b} = ${a - b}.`
              };
            }
          });
        }
        
        // Absolute value inequalities (grades 9+)
        if (this.grade >= 9) {
          types.push(() => {
            const a = this.randomInt(1, 5);
            const b = this.randomInt(1, 5);
            const op = this.randomChoice(['<', '>', '≤', '≥']);
            
            if (op === '<' || op === '≤') {
              return {
                question: `Solve: |x - ${a}| ${op} ${b}`,
                answer: `${a - b} ${op} x ${op} ${a + b}`,
                type: "absolute value",
                explanation: `|x - ${a}| ${op} ${b} means the distance between x and ${a} is less than ${b}. So x must be between ${a - b} and ${a + b}.`
              };
            } else {
              return {
                question: `Solve: |x - ${a}| ${op} ${b}`,
                answer: `x ≤ ${a - b} or x ${op} ${a + b}`,
                type: "absolute value",
                explanation: `|x - ${a}| ${op} ${b} means x is at least ${b} units away from ${a}. So x ≤ ${a - b} OR x ≥ ${a + b}.`
              };
            }
          });
        }
        
        return types[Math.floor(Math.random() * types.length)]();
      }

      // Factors and Multiples (Grades 4-8)
      generateFactors() {
        if (this.grade < 4) return null;
        
        const num = this.randomInt(10, 50);
        const factors = this.getFactors(num);
        
        return {
          question: `List all the factors of ${num}. (Separate with commas)`,
          answer: factors.join(','),
          type: "factors",
          explanation: `Factors of ${num} are numbers that divide evenly into ${num}: ${factors.join(', ')}.`
        };
      }

      generateMultiples() {
        if (this.grade < 4) return null;
        
        const num = this.randomInt(2, 10);
        const count = this.randomInt(3, 6);
        const multiples = Array.from({length: count}, (_, i) => num * (i + 1));
        
        return {
          question: `List the first ${count} multiples of ${num}. (Separate with commas)`,
          answer: multiples.join(','),
          type: "multiples",
          explanation: `Multiples of ${num} are obtained by multiplying ${num} by 1, 2, 3,...: ${multiples.join(', ')}.`
        };
      }

      // Prime Numbers (Grades 4-12)
      generatePrimeNumbers() {
        if (this.grade < 4) return null;
        
        const primes = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47];
        const nonPrimes = [4, 6, 8, 9, 10, 12, 14, 15, 16, 18, 20, 21, 22, 24, 25];
        
        if (Math.random() > 0.5) {
          // Identify prime numbers
          const num = this.randomChoice(Math.random() > 0.5 ? primes : nonPrimes);
          return {
            question: `Is ${num} a prime number? (yes/no)`,
            answer: primes.includes(num) ? 'yes' : 'no',
            type: "prime numbers",
            explanation: primes.includes(num) 
              ? `${num} is prime because its only factors are 1 and itself.`
              : `${num} is not prime because it has factors other than 1 and itself (e.g. ${this.getFactors(num).filter(f => f !== 1 && f !== num).join(', ')}).`
          };
        } else {
          // Find prime numbers in range
          const start = this.randomInt(10, 30);
          const end = start + this.randomInt(10, 20);
          const primesInRange = primes.filter(p => p >= start && p <= end);
          
          return {
            question: `List all prime numbers between ${start} and ${end}. (Separate with commas)`,
            answer: primesInRange.join(','),
            type: "prime numbers",
            explanation: `Prime numbers between ${start} and ${end} are: ${primesInRange.join(', ')}.`
          };
        }
      }

      // Sequences (Grades 5-12)
      generateSequences() {
        if (this.grade < 5) return null;
        
        const types = [];
        
        // Arithmetic sequences (grades 5+)
        types.push(() => {
          const start = this.randomInt(1, 10);
          const diff = this.randomInt(1, 5);
          const position = this.randomInt(5, 10);
          
          return {
            question: `Find the ${position}${this.getOrdinalSuffix(position)} term in the sequence: ${start}, ${start + diff}, ${start + 2*diff}, ...`,
            answer: (start + (position - 1) * diff).toString(),
            type: "sequences",
            explanation: `This is an arithmetic sequence where each term increases by ${diff}. The nth term = first term + (n-1) × difference. So term ${position} = ${start} + ${position-1} × ${diff} = ${start + (position - 1) * diff}.`
          };
        });
        
        // Geometric sequences (grades 7+)
        if (this.grade >= 7) {
          types.push(() => {
            const start = this.randomInt(1, 5);
            const ratio = this.randomInt(2, 4);
            const position = this.randomInt(4, 6);
            
            return {
              question: `Find the ${position}${this.getOrdinalSuffix(position)} term in the sequence: ${start}, ${start * ratio}, ${start * ratio * ratio}, ...`,
              answer: (start * Math.pow(ratio, position - 1)).toString(),
              type: "sequences",
              explanation: `This is a geometric sequence where each term is multiplied by ${ratio}. The nth term = first term × ratio^(n-1). So term ${position} = ${start} × ${ratio}^${position-1} = ${start * Math.pow(ratio, position - 1)}.`
            };
          });
        }
        
        // Fibonacci sequence (grades 6+)
        if (this.grade >= 6) {
          types.push(() => {
            const position = this.randomInt(5, 8);
            const fib = this.generateFibonacci(position);
            
            return {
              question: `Find the ${position}${this.getOrdinalSuffix(position)} number in the Fibonacci sequence.`,
              answer: fib[position - 1].toString(),
              type: "sequences",
              explanation: `The Fibonacci sequence starts with 1, 1, and each subsequent number is the sum of the two preceding ones. The first ${position} numbers are: ${fib.slice(0, position).join(', ')}.`
            };
          });
        }
        
        // Quadratic sequences (grades 9+)
        if (this.grade >= 9) {
          types.push(() => {
            const a = this.randomInt(1, 3) / 2;
            const b = this.randomInt(-2, 2);
            const c = this.randomInt(1, 5);
            const position = this.randomInt(4, 6);
            
            const terms = Array.from({length: position}, (_, i) => 
              Math.round(a * Math.pow(i+1, 2) + b * (i+1) + c)
            );
            
            return {
              question: `Find the next term in the sequence: ${terms.slice(0, position-1).join(', ')}, ...`,
              answer: terms[position-1].toString(),
              type: "sequences",
              explanation: `This is a quadratic sequence where each term follows the pattern an² + bn + c. The next term is ${terms[position-1]}.`
            };
          });
        }
        
        return types[Math.floor(Math.random() * types.length)]();
      }

      // Probability (Grades 6-12)
      generateProbability() {
        if (this.grade < 6) return null;
        
        const types = [];
        
        // Simple probability (grades 6-8)
        types.push(() => {
          const total = this.randomInt(5, 20);
          const successes = this.randomInt(1, total - 1);
          
          return {
            question: `A jar has ${successes} red marbles and ${total - successes} blue marbles. What is the probability of drawing a red marble? (Express as a fraction)`,
            answer: `${successes}/${total}`,
            type: "probability",
            explanation: `Probability = (Number of successful outcomes) / (Total possible outcomes) = ${successes}/${total}.`
          };
        });
        
        // Compound probability (grades 8+)
        if (this.grade >= 8) {
          types.push(() => {
            const prob1 = this.randomInt(1, 4);
            const prob2 = this.randomInt(1, 4);
            const isIndependent = Math.random() > 0.5;
            
            if (isIndependent) {
              return {
                question: `Event A has a ${prob1}/4 chance, Event B has a ${prob2}/4 chance. If independent, what's the probability of both A and B occurring? (Express as a fraction)`,
                answer: `${prob1 * prob2}/16`,
                type: "probability",
                explanation: `For independent events, P(A and B) = P(A) × P(B) = ${prob1}/4 × ${prob2}/4 = ${prob1 * prob2}/16.`
              };
            } else {
              return {
                question: `A bag has 3 red and 2 blue marbles. If you draw 2 marbles without replacement, what's the probability both are red? (Express as a fraction)`,
                answer: `3/10`,
                type: "probability",
                explanation: `P(First red) = 3/5. P(Second red) = 2/4. So P(Both red) = 3/5 × 2/4 = 6/20 = 3/10.`
              };
            }
          });
        }
        
        // Conditional probability (grades 10+)
        if (this.grade >= 10) {
          types.push(() => {
            return {
              question: `In a class, 60% of students are girls. 30% of girls and 40% of boys play sports. What's the probability a randomly chosen sports player is a girl? (Express as a decimal)`,
              answer: `0.529`,
              type: "probability",
              explanation: `P(Girl|Sports) = P(Sports|Girl) × P(Girl) / P(Sports) = (0.3 × 0.6) / (0.3 × 0.6 + 0.4 × 0.4) ≈ 0.529 or 52.9%.`
            };
          });
        }
        
        return types[Math.floor(Math.random() * types.length)]();
      }

      // ========== HELPER METHODS ==========
      randomInt(min, max) {
        return Math.floor(min + Math.random() * (max - min + 1));
      }

      randomChoice(items) {
        return items[Math.floor(Math.random() * items.length)];
      }

      calculate(a, b, op) {
        switch(op) {
          case '+': return a + b;
          case '-': return a - b;
          case '×': return a * b;
          case '÷': return a / b;
          case '^': return Math.pow(a, b);
          default: return 0;
        }
      }

      compareNumbers(a, b, op) {
        switch(op) {
          case '<': return a < b ? '<' : '≥';
          case '>': return a > b ? '>' : '≤';
          case '≤': return a <= b ? '≤' : '>';
          case '≥': return a >= b ? '≥' : '<';
          default: return '=';
        }
      }

      getComparisonExplanation(a, b) {
        if (a < b) return `${a} is less than ${b}`;
        if (a > b) return `${a} is greater than ${b}`;
        return `${a} is equal to ${b}`;
      }

      getFactors(num) {
        const factors = [1];
        for (let i = 2; i <= num / 2; i++) {
          if (num % i === 0) factors.push(i);
        }
        if (num > 1) factors.push(num);
        return factors;
      }

      generateFibonacci(n) {
        const fib = [1, 1];
        for (let i = 2; i < n; i++) {
          fib.push(fib[i-1] + fib[i-2]);
        }
        return fib;
      }

      getOrdinalSuffix(num) {
        const j = num % 10, k = num % 100;
        if (j === 1 && k !== 11) return 'st';
        if (j === 2 && k !== 12) return 'nd';
        if (j === 3 && k !== 13) return 'rd';
        return 'th';
      }

      validateProblem(problem) {
        if (!problem || typeof problem !== "object") return false;
        if (!problem.question || typeof problem.question !== "string") return false;
        if (problem.answer === undefined || problem.answer === null) return false;
        if (!problem.type || typeof problem.type !== "string") return false;
        return true;
      }

      getFallbackProblem() {
        return {
          question: "10 + 10 = ?",
          answer: "20",
          type: "addition",
          explanation: "To add 10 and 10, count 10 items and then count 10 more items. The total is 20."
        };
      }
    }

    // ==============================================
    // GAME ENGINE WITH ALL FEATURES
    // ==============================================
    class MathVerseGame {
      constructor() {
        this.state = {
          grade: null,
          xp: 0,
          level: 1,
          streak: 0,
          heroHealth: 100,
          enemyHealth: 100,
          currentProblem: null,
          generator: null,
          timer: 60,
          timerInterval: null,
          powerUpVisible: false,
          xpToNextLevel: 100,
          isProcessing: false,
          problemsSolved: 0,
          teacherActive: false
        };
        
        this.cacheElements();
        this.initEventListeners();
        this.initGradeSelector();
        this.updateUI();
      }
      
      cacheElements() {
        this.elements = {
          // Game elements
          problem: document.getElementById('problem-display'),
          answerInput: document.getElementById('answer-input'),
          submitBtn: document.getElementById('submit-btn'),
          feedback: document.getElementById('feedback'),
          explanation: document.getElementById('explanation'),
          
          // Character elements
          hero: document.getElementById('hero'),
          enemy: document.getElementById('enemy'),
          teacher: document.getElementById('teacher'),
          teacherSpeech: document.getElementById('teacher-speech'),
          heroHealth: document.getElementById('hero-health'),
          enemyHealth: document.getElementById('enemy-health'),
          heroHealthText: document.getElementById('hero-health-text'),
          enemyHealthText: document.getElementById('enemy-health-text'),
          
          // Progress elements
          xpCounter: document.getElementById('xp-counter'),
          levelDisplay: document.getElementById('level-display'),
          streakDisplay: document.getElementById('streak-display'),
          
          // UI elements
          gradeSelector: document.getElementById('grade-selector'),
          timerDisplay: document.getElementById('time'),
          powerUp: document.getElementById('power-up'),
          mobileBtns: Array.from(document.querySelectorAll('.mobile-btn')),
          
          // LED effects
          ledPulse: document.getElementById('led-pulse')
        };
      }
      
      initEventListeners() {
        // Submit answer
        this.elements.submitBtn.addEventListener('click', () => this.checkAnswer());
        this.elements.answerInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.checkAnswer();
        });
        
        // Mobile number buttons
        this.elements.mobileBtns.forEach(btn => {
          if (btn.id.startsWith('btn-') && !isNaN(btn.id.slice(-1))) {
            btn.addEventListener('click', () => {
              if (!this.state.isProcessing) {
                this.elements.answerInput.value += btn.id.slice(-1);
                this.elements.answerInput.focus();
              }
            });
          }
        });
        
        // Clear button
        document.getElementById('btn-clear').addEventListener('click', () => {
          if (!this.state.isProcessing) {
            this.elements.answerInput.value = '';
            this.elements.answerInput.focus();
          }
        });
        
        // Power-up click
        this.elements.powerUp.addEventListener('click', () => this.collectPowerUp());
      }
      
      initGradeSelector() {
        const container = this.elements.gradeSelector;
        container.innerHTML = '<h2>Choose Your Grade Level:</h2>';
        
        // Create grade buttons (1-12)
        for (let grade = 1; grade <= 12; grade++) {
          const btn = document.createElement('button');
          btn.className = 'grade-btn';
          btn.textContent = `Grade ${grade}`;
          btn.addEventListener('click', () => this.startGrade(grade));
          container.appendChild(btn);
        }
      }
      
      startGrade(grade) {
        if (this.state.isProcessing) return;
        
        try {
          this.resetGame();
          this.state.grade = grade;
          this.state.generator = new MathProblemGenerator(grade);
          
          this.enableInput();
          this.loadNewProblem();
          this.startTimer();
          this.schedulePowerUp();
          
          // Show teacher for grades 1-6
          if (grade <= 6) {
            this.state.teacherActive = true;
            this.elements.teacher.style.display = 'block';
          }
          
        } catch (error) {
          console.error("Error starting grade:", error);
          this.showFeedback("Failed to start game. Please try again.", "error");
          this.disableInput();
        }
      }
      
      resetGame() {
        clearInterval(this.state.timerInterval);
        clearTimeout(this.state.powerUpTimer);
        clearTimeout(this.state.powerUpTimeout);
        
        this.state = {
          ...this.state,
          grade: null,
          xp: 0,
          level: 1,
          streak: 0,
          heroHealth: 100,
          enemyHealth: 100,
          timer: 60,
          powerUpVisible: false,
          xpToNextLevel: 100,
          isProcessing: false,
          problemsSolved: 0,
          teacherActive: false
        };
        
        this.updateUI();
        this.hidePowerUp();
        this.elements.teacher.style.display = 'none';
        this.elements.teacherSpeech.style.display = 'none';
        this.elements.explanation.style.display = 'none';
      }
      
      startTimer() {
        clearInterval(this.state.timerInterval);
        this.state.timer = 60;
        this.updateTimerDisplay();
        
        this.state.timerInterval = setInterval(() => {
          this.state.timer--;
          this.updateTimerDisplay();
          
          if (this.state.timer <= 0) {
            clearInterval(this.state.timerInterval);
            this.showFeedback("⏰ Time's up! Select a grade to play again.", "warning");
            this.disableInput();
            this.triggerLEDEffect('red');
          }
        }, 1000);
      }
      
      updateTimerDisplay() {
        this.elements.timerDisplay.textContent = this.state.timer;
        this.elements.timerDisplay.style.color = this.state.timer <= 10 ? "var(--error)" : "";
        
        // Pulse effect when time is running low
        if (this.state.timer <= 10) {
          this.triggerLEDEffect('red', 1000);
        }
      }
      
      schedulePowerUp() {
        this.state.powerUpTimer = setTimeout(() => {
          if (this.state.grade && !this.state.powerUpVisible && !this.state.isProcessing) {
            this.showPowerUp();
          }
        }, 15000 + Math.random() * 30000);
      }
      
      showPowerUp() {
        this.state.powerUpVisible = true;
        const powerUp = this.elements.powerUp;
        
        // Random position in battle arena
        const arenaRect = document.getElementById('battle-arena').getBoundingClientRect();
        const maxX = arenaRect.width - 40;
        const maxY = arenaRect.height - 40;
        
        powerUp.style.display = "block";
        powerUp.style.left = `${20 + Math.random() * maxX}px`;
        powerUp.style.top = `${20 + Math.random() * maxY}px`;
        
        // Hide after 5 seconds if not collected
        this.state.powerUpTimeout = setTimeout(() => {
          if (this.state.powerUpVisible) {
            this.hidePowerUp();
          }
        }, 5000);
      }
      
      hidePowerUp() {
        this.state.powerUpVisible = false;
        this.elements.powerUp.style.display = "none";
        this.schedulePowerUp();
      }
      
      collectPowerUp() {
        if (!this.state.powerUpVisible || this.state.isProcessing) return;
        
        this.state.isProcessing = true;
        const bonus = 50 + Math.floor(Math.random() * 100);
        this.state.xp += bonus;
        
        this.showFeedback(`✨ Power-up collected! +${bonus} XP`, "success");
        document.getElementById('powerup-sound').play();
        this.createConfetti(20);
        this.hidePowerUp();
        this.triggerLEDEffect('yellow');
        
        this.checkLevelUp();
        this.updateUI();
        this.state.isProcessing = false;
      }
      
      loadNewProblem() {
        if (this.state.isProcessing) return;
        this.state.isProcessing = true;
        
        try {
          this.state.currentProblem = this.state.generator.generate();
          
          if (!this.state.currentProblem || !this.state.currentProblem.question) {
            throw new Error("Failed to generate valid problem");
          }
          
          this.elements.problem.textContent = this.state.currentProblem.question
            .replace(/\\\(/g, '')
            .replace(/\\\)/g, '')
            .replace(/\\frac/g, '');
          
          this.elements.answerInput.value = '';
          this.elements.feedback.textContent = '';
          this.elements.feedback.className = '';
          this.elements.explanation.style.display = 'none';
          this.elements.answerInput.focus();
          
        } catch (error) {
          console.error("Error loading problem:", error);
          this.showFeedback("Error loading problem. Trying again...", "error");
          setTimeout(() => this.loadNewProblem(), 1000);
        } finally {
          this.state.isProcessing = false;
        }
      }
      
      checkAnswer() {
        if (this.state.isProcessing) return;
        this.state.isProcessing = true;
        
        try {
          const userAnswer = this.elements.answerInput.value.trim();
          
          if (!userAnswer) {
            this.showFeedback("Please enter an answer!", "warning");
            this.state.isProcessing = false;
            return;
          }

          // Check if answer is correct (case insensitive and flexible formatting)
          const correctAnswer = this.state.currentProblem.answer.toString().toLowerCase();
          const normalizedUserAnswer = userAnswer.toLowerCase().replace(/\s+/g, '');

          let isCorrect = false;
          
          // More flexible answer checking for different formats
          if (correctAnswer.includes(',')) {
            // For multiple part answers (like x=1, y=2)
            isCorrect = correctAnswer.split(',').every(part => 
              normalizedUserAnswer.includes(part.replace(/\s+/g, ''))
            );
          } else if (correctAnswer.includes('=')) {
            // For equations (like x=5)
            isCorrect = normalizedUserAnswer.includes(correctAnswer.split('=')[1].trim());
          } else {
            // For simple answers
            isCorrect = normalizedUserAnswer === correctAnswer || 
                       normalizedUserAnswer === correctAnswer.replace(/\s+/g, '');
          }

          if (isCorrect) {
            this.handleCorrectAnswer();
          } else {
            this.handleIncorrectAnswer();
          }

          // Update streak counter
          if (isCorrect) {
            this.state.streak++;
          } else {
            this.state.streak = 0;
          }

          // Update UI
          this.updateUI();
          
          // Load new problem after delay
          setTimeout(() => {
            this.loadNewProblem();
            this.state.isProcessing = false;
          }, 1500);

        } catch (error) {
          console.error("Error checking answer:", error);
          this.showFeedback("Error processing answer. Try again!", "error");
          this.state.isProcessing = false;
        }
      }
      
      handleCorrectAnswer() {
        // Play correct sound
        document.getElementById('correct-sound').play();
        
        // Calculate XP gain (base + streak bonus)
        const baseXP = 10 + (this.state.grade * 2);
        const streakBonus = Math.min(50, this.state.streak * 5);
        const totalXP = baseXP + streakBonus;
        
        this.state.xp += totalXP;
        this.state.problemsSolved++;
        
        // Enemy takes damage
        const damage = 10 + (this.state.level * 2);
        this.state.enemyHealth = Math.max(0, this.state.enemyHealth - damage);
        
        // Show feedback with XP earned
        this.showFeedback(
          `✅ Correct! +${totalXP} XP (${baseXP} + ${streakBonus} streak)`, 
          "success"
        );
        
        // Visual effects
        this.elements.enemy.classList.add('damage');
        setTimeout(() => this.elements.enemy.classList.remove('damage'), 300);
        this.createConfetti(5);
        this.triggerLEDEffect('green');
        
        // Teacher encouragement
        if (this.state.teacherActive && Math.random() > 0.7) {
          this.showTeacherMessage([
            "Great job!",
            "You're amazing!",
            "Keep it up!",
            "Math superstar!",
            "Brilliant work!"
          ]);
        }
        
        // Check for enemy defeat
        if (this.state.enemyHealth <= 0) {
          this.defeatEnemy();
        }
        
        // Check for level up
        this.checkLevelUp();
      }
      
      handleIncorrectAnswer() {
        // Play wrong sound
        document.getElementById('wrong-sound').play();
        
        // Hero takes damage
        const damage = 15;
        this.state.heroHealth = Math.max(0, this.state.heroHealth - damage);
        
        // Show feedback with correct answer and explanation
        this.showFeedback(
          `❌ Incorrect! The answer was ${this.state.currentProblem.answer}`,
          "error"
        );
        
        // Show detailed explanation
        if (this.state.currentProblem.explanation) {
          this.elements.explanation.innerHTML = `
            <h3>Explanation:</h3>
            <p>${this.state.currentProblem.explanation}</p>
          `;
          this.elements.explanation.style.display = 'block';
        }
        
        // Visual effects
        this.elements.hero.classList.add('damage');
        setTimeout(() => this.elements.hero.classList.remove('damage'), 300);
        this.triggerLEDEffect('red');
        
        // Teacher help
        if (this.state.teacherActive) {
          this.showTeacherMessage([
            "Let me help you with this one!",
            "Don't worry, let's try again!",
            "Here's how to solve it...",
            "You'll get it next time!",
            "Here's a hint for you..."
          ]);
        }
        
        // Check for game over
        if (this.state.heroHealth <= 0) {
          this.gameOver();
        }
      }
      
      showTeacherMessage(messages) {
        const message = Array.isArray(messages) ? this.randomChoice(messages) : messages;
        this.elements.teacherSpeech.textContent = message;
        this.elements.teacherSpeech.style.display = 'block';
        document.getElementById('teacher-sound').play();
        
        setTimeout(() => {
          this.elements.teacherSpeech.style.display = 'none';
        }, 3000);
      }
      
      defeatEnemy() {
        // Big XP bonus for defeating enemy
        const bonusXP = 100;
        this.state.xp += bonusXP;
        
        this.showFeedback(
          `🎉 Enemy defeated! +${bonusXP} XP. New enemy spawned!`,
          "success"
        );
        
        // Play level up sound
        document.getElementById('levelup-sound').play();
        
        // Create lots of confetti
        this.createConfetti(30);
        this.triggerLEDEffect('blue');
        
        // Reset enemy health (with level scaling)
        this.state.enemyHealth = 100 + (this.state.level * 10);
        
        // Check for level up
        this.checkLevelUp();
      }
      
      gameOver() {
        clearInterval(this.state.timerInterval);
        this.showFeedback(
          `💀 Game Over! You solved ${this.state.problemsSolved} problems. Select a grade to play again.`,
          "error"
        );
        this.disableInput();
        this.triggerLEDEffect('red', 3000);
      }
      
      checkLevelUp() {
        const xpNeeded = this.state.xpToNextLevel;
        
        if (this.state.xp >= xpNeeded) {
          this.state.level++;
          this.state.xp -= xpNeeded;
          this.state.xpToNextLevel = Math.floor(xpNeeded * 1.5);
          
          // Play level up sound
          document.getElementById('levelup-sound').play();
          
          // Show level up message
          this.showFeedback(
            `🎊 Level Up! Now level ${this.state.level}`,
            "success"
          );
          
          // Create lots of confetti
          this.createConfetti(20);
          this.triggerLEDEffect('blue');
          
          // Heal hero on level up
          this.state.heroHealth = Math.min(100, this.state.heroHealth + 30);
        }
      }
      
      createConfetti(count) {
        const battleArena = document.getElementById('battle-arena');
        
        for (let i = 0; i < count; i++) {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          
          // Random position
          const x = Math.random() * 100;
          const y = Math.random() * 100;
          
          // Random color
          const colors = ['var(--accent)', 'var(--primary)', 'var(--secondary)', 'white'];
          const color = colors[Math.floor(Math.random() * colors.length)];
          
          // Random size
          const size = 5 + Math.random() * 10;
          
          confetti.style.left = `${x}%`;
          confetti.style.top = `${y}%`;
          confetti.style.backgroundColor = color;
          confetti.style.width = `${size}px`;
          confetti.style.height = `${size}px`;
          
          // Random animation
          const duration = 1 + Math.random() * 2;
          const angle = Math.random() * Math.PI * 2;
          const distance = 50 + Math.random() * 100;
          
          confetti.style.animation = `
            confetti-fall ${duration}s ease-out forwards,
            confetti-spin ${duration}s linear forwards
          `;
          
          confetti.style.setProperty('--distance-x', `${Math.cos(angle) * distance}px`);
          confetti.style.setProperty('--distance-y', `${Math.sin(angle) * distance}px`);
          confetti.style.setProperty('--rotation', `${Math.random() * 360}deg`);
          
          battleArena.appendChild(confetti);
          
          // Remove after animation
          setTimeout(() => confetti.remove(), duration * 1000);
        }
      }
      
      triggerLEDEffect(color, duration = 1000) {
        const led = this.elements.ledPulse;
        led.className = `led-pulse ${color}`;
        led.style.opacity = '0.5';
        led.style.animation = 'none';
        led.offsetHeight; // Trigger reflow
        led.style.animation = `pulse ${duration}ms ease-out`;
        
        setTimeout(() => {
          led.style.opacity = '0';
        }, duration);
      }
      
      showFeedback(message, type) {
        this.elements.feedback.textContent = message;
        this.elements.feedback.className = type;
      }
      
      enableInput() {
        this.elements.answerInput.disabled = false;
        this.elements.submitBtn.disabled = false;
      }
      
      disableInput() {
        this.elements.answerInput.disabled = true;
        this.elements.submitBtn.disabled = true;
      }
      
      updateUI() {
        // Update health bars
        this.elements.heroHealth.style.width = `${this.state.heroHealth}%`;
        this.elements.enemyHealth.style.width = `${this.state.enemyHealth}%`;
        this.elements.heroHealthText.textContent = `${this.state.heroHealth}/100`;
        this.elements.enemyHealthText.textContent = `${this.state.enemyHealth}/100`;
        
        // Update progress
        this.elements.xpCounter.textContent = this.state.xp;
        this.elements.levelDisplay.textContent = this.state.level;
        this.elements.streakDisplay.textContent = this.state.streak;
        
        // Color health bars based on status
        if (this.state.heroHealth < 30) {
          this.elements.heroHealth.style.background = 'linear-gradient(to right, var(--error), #FF1744)';
        } else {
          this.elements.heroHealth.style.background = 'linear-gradient(to right, var(--secondary), #2BBBAD)';
        }
        
        if (this.state.enemyHealth < 30) {
          this.elements.enemyHealth.style.background = 'linear-gradient(to right, var(--warning), #FF9100)';
        } else {
          this.elements.enemyHealth.style.background = 'linear-gradient(to right, var(--primary), #FF5252)';
        }
      }
      
      randomChoice(items) {
        return items[Math.floor(Math.random() * items.length)];
      }
    }

    // ==============================================
    // INITIALIZE THE GAME AFTER LOADING
    // ==============================================
    document.addEventListener('DOMContentLoaded', function() {
      const loadingScreen = document.getElementById('loading-screen');
      const progressBar = document.querySelector('.progress-bar');
      const loadingTip = document.getElementById('loading-tip');
      
      // Fun loading tips
      const tips = [
        "Did you know? The word 'mathematics' comes from the Greek word 'máthēma' meaning 'knowledge'.",
        "Pro tip: Practice math daily to keep your skills sharp!",
        "The number 0 was invented in India around the 5th century.",
        "A 'jiffy' is an actual unit of time - 1/100th of a second!",
        "The equals sign (=) was invented in 1557 by Welsh mathematician Robert Recorde.",
        "There are 86,400 seconds in a day. Can you calculate how many in a week?",
        "The Fibonacci sequence appears often in nature - in pinecones, sunflowers, and more!",
        "The largest known prime number has over 24 million digits!"
      ];
      
      // Simulate loading progress
      let progress = 0;
      const loadingInterval = setInterval(function() {
        // Update progress
        progress += Math.random() * 10;
        if (progress > 100) progress = 100;
        progressBar.style.width = progress + '%';
        
        // Change tip every few seconds
        if (progress % 25 === 0) {
          loadingTip.textContent = tips[Math.floor(Math.random() * tips.length)];
        }
        
        // Complete loading
        if (progress >= 100) {
          clearInterval(loadingInterval);
          loadingTip.textContent = "Ready to begin your math adventure!";
          
          // Add fade out animation
          loadingScreen.style.opacity = '0';
          setTimeout(function() {
            loadingScreen.style.display = 'none';
            
            // Initialize the game after loading
            window.mathVerseGame = new MathVerseGame();
          }, 500);
        }
      }, 150);
    });
  </script>
</body>
</html>
